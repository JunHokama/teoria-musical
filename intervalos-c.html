<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Piano Interval Master</title>
    <style>
        :root {
            --bg: #1e1e2e;
            --primary: #f5c2e7;
            --correct: #a6e3a1;
            --wrong: #f38ba8;
            --white-key: #f8f9fa;
            --black-key: #181825;
        }

        body { 
            font-family: 'Segoe UI', sans-serif; background: var(--bg); 
            color: #cdd6f4; margin: 0; display: flex; flex-direction: column; 
            align-items: center; min-height: 100vh; overflow: hidden;
        }

        .hud {
            padding: 30px; text-align: center; width: 100%;
            background: rgba(0,0,0,0.2);
        }

        #instruction { font-size: 1rem; opacity: 0.8; margin-bottom: 5px; }
        #target-interval { 
            font-size: 2.8rem; font-weight: 800; color: var(--primary);
            text-shadow: 0 0 20px rgba(245, 194, 231, 0.3); margin: 10px 0;
        }

        .piano-container {
            position: relative; height: 250px; margin-top: 50px;
            display: flex; justify-content: center; padding-bottom: 50px;
        }

        .piano { display: flex; position: relative; cursor: pointer; }

        .key {
            width: 50px; height: 200px; background: var(--white-key);
            border: 1px solid #ddd; border-radius: 0 0 5px 5px;
            position: relative; z-index: 1; transition: background 0.1s;
            user-select: none;
        }

        .key.black {
            width: 34px; height: 120px; background: var(--black-key);
            margin-left: -17px; margin-right: -17px;
            z-index: 2; border: none;
        }

        .key.correct-flash { background: var(--correct) !important; transform: translateY(2px); }
        .key.wrong-flash { background: var(--wrong) !important; animation: shake 0.2s; }

        .ref-mark {
            position: absolute; bottom: 10px; left: 50%;
            transform: translateX(-50%); color: #888; font-weight: bold;
            font-size: 0.8rem; pointer-events: none;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(5px); }
        }

        .stats { font-size: 1.2rem; font-weight: bold; margin-top: 20px; }
    </style>
</head>
<body>

<div class="hud">
    <div id="instruction">Toque a nota que representa o intervalo:</div>
    <div id="target-interval">Aguardando...</div>
    <div class="stats">SCORE: <span id="score">0</span></div>
</div>

<div class="piano-container">
    <div class="piano" id="piano"></div>
</div>

<div style="margin-top: 20px; opacity: 0.6; text-align: center; padding: 20px;">
    DICA: A primeira tecla branca à esquerda é o <b>Dó (C)</b>.<br>
    Clique nas teclas para ouvir e responder.
</div>

<script>
    // Inicialização do Áudio (Contexto criado no primeiro clique)
    let audioCtx = null;

    function playNote(semitones) {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();

        // Frequência de Dó3
        const baseFreq = 261.63;
        const frequency = baseFreq * Math.pow(2, semitones / 12);

        oscillator.type = 'triangle';
        oscillator.frequency.setValueAtTime(frequency, audioCtx.currentTime);

        gainNode.gain.setValueAtTime(0.4, audioCtx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.6);

        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);

        oscillator.start();
        oscillator.stop(audioCtx.currentTime + 0.6);
    }

    const allIntervals = [
        { name: "Tônica (C)", semi: 0 },
        { name: "2ª Menor", semi: 1 },
        { name: "2ª Maior", semi: 2 },
        { name: "3ª Menor", semi: 3 },
        { name: "2ª Aumentada", semi: 3 },
        { name: "3ª Maior", semi: 4 },
        { name: "4ª Justa", semi: 5 },
        { name: "4ª Aumentada", semi: 6 },
        { name: "5ª Diminuta", semi: 6 },
        { name: "5ª Justa", semi: 7 },
        { name: "6ª Menor", semi: 8 },
        { name: "5ª Aumentada", semi: 8 },
        { name: "6ª Maior", semi: 9 },
        { name: "7ª Diminuta", semi: 9 },
        { name: "7ª Menor", semi: 10 },
        { name: "7ª Maior", semi: 11 },
        { name: "Oitava", semi: 12 }
    ];

    let questionPool = []; 
    let currentInterval = {};
    let score = 0;
    let canPlay = true;

    function shuffle(array) {
        let currentIndex = array.length;
        while (currentIndex != 0) {
            let randomIndex = Math.floor(Math.random() * currentIndex);
            currentIndex--;
            [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
        }
        return array;
    }

    function createPiano() {
        const piano = document.getElementById('piano');
        piano.innerHTML = '';
        const pattern = [1, 1, 0, 1, 1, 1, 0]; 
        let semi = 0;

        for (let i = 0; i < 8; i++) {
            addKey(piano, false, semi++); 
            if (pattern[i] && semi < 13) {
                addKey(piano, true, semi++); 
            }
        }
    }

    function addKey(container, isBlack, semitone) {
        const key = document.createElement('div');
        key.className = `key ${isBlack ? 'black' : 'white'}`;
        key.dataset.semi = semitone;
        if (semitone === 0 || semitone === 12) {
            key.innerHTML = '<span class="ref-mark">C</span>';
        }
        key.onmousedown = () => checkAnswer(semitone, key); // Usando mousedown para resposta mais rápida
        container.appendChild(key);
    }

    function nextQuestion() {
        if (questionPool.length === 0) {
            questionPool = shuffle([...allIntervals]);
        }

        canPlay = true;
        currentInterval = questionPool.pop(); 
        document.getElementById('target-interval').innerText = currentInterval.name;
        
        document.querySelectorAll('.key').forEach(k => {
            k.classList.remove('correct-flash', 'wrong-flash');
        });
    }

    function checkAnswer(clickedSemi, element) {
        // Toca o som independente de ser a vez de responder ou não (permite "explorar" o piano)
        playNote(clickedSemi);

        if (!canPlay) return;

        if (clickedSemi === currentInterval.semi) {
            canPlay = false;
            score += 10;
            element.classList.add('correct-flash');
            document.getElementById('score').innerText = score;
            setTimeout(nextQuestion, 800);
        } else {
            element.classList.add('wrong-flash');
            setTimeout(() => element.classList.remove('wrong-flash'), 300);
            score = Math.max(0, score - 5);
            document.getElementById('score').innerText = score;
        }
    }

    createPiano();
    nextQuestion();
</script>

</body>
</html>